language: python
dist: bionic
sudo: true
cache:
  pip: true
addons:
  chrome: stable
  hosts:
  - authomatic.test
  - authomatic.com
  - authomatic.org
install:
- sudo pip install tox
script:
- sudo tox -e py3 -- -vvx --tb=no
after_failure:
- tail -n 500 tests/functional_tests/*.log
- tail -n 500 tests/*.log
- tail -n 500 flask.log
before_install:
- openssl aes-256-cbc -K $encrypted_dbe8ae205660_key -iv $encrypted_dbe8ae205660_iv
  -in ./tests/functional_tests/config.py.enc -out ./tests/functional_tests/config.py
  -d
before_deploy:
# Check out an expicit branch to avoid detached HEAD (which prelease complains about)
- git checkout ${TRAVIS_BRANCH}
- pip install zestreleaser.towncrier zest.releaser[recommended]
- git config --local user.email "authomaticproject@protonmail.com"
- git config --local user.name "TravisCI"
- git remote add origin https://${GITHUB_TOKEN}@github.com/authomatic/authomatic.git > /dev/null 2>&1 || git remote set-url origin https://${GITHUB_TOKEN}@github.com/authomatic/authomatic.git > /dev/null 2>&1
- prerelease --no-input --verbose
- release --no-input --verbose
- git push
- git push --tags
- pip install -r requirements-docs.txt
- make html -C doc/
deploy:
  - provider: pypi
    user: "__token__"
    # password: is defined via encrypted env var $PYPI_PASSWORD (stored on travis server)
    skip_cleanup: true
    distributions: "sdist bdist_wheel"
    server: https://test.pypi.org/legacy/
    on:
      # We need to set this as default branch: master overrides condition
      all_branches: true
      condition: $TRAVIS_BRANCH =~ ^(prepare-.*)$
  - provider: pages
    local_dir: doc/build/html
    target_branch: test-ghpages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
    keep_history: true
    on:
      # We need to set this as default branch: master overrides condition
      all_branches: true
      condition: $TRAVIS_BRANCH =~ ^(prepare-.*)$
after_deploy:
- postrelease --no-input --verbose
- git push
- git push --delete origin $TRAVIS_TAG
